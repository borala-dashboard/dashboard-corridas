<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — Movimentação diária (corridas e passageiros)</title>

  <!-- Chart.js (gráficos) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- SheetJS (ler XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --accent:#2563eb;
      --ok:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
      --radius:18px;
      --shadow:0 10px 28px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 550px at 12% 10%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(900px 550px at 88% 12%, rgba(22,163,74,.10), transparent 55%),
        linear-gradient(180deg, var(--bg), #ffffff);
      color:var(--text);
      line-height:1.35;
    }
    header{
      max-width:1200px;
      margin:26px auto 10px;
      padding:0 18px;
    }
    h1{margin:0 0 6px; font-size:26px}
    .sub{margin:0; color:var(--muted)}
    .wrap{max-width:1200px; margin:18px auto 40px; padding:0 18px; display:grid; gap:16px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }

    .controls{display:grid; grid-template-columns: 1.2fr .8fr .8fr 1.2fr; gap:12px; align-items:end;}
    .ctrl label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px;}
    .ctrl input, .ctrl select, .ctrl button{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    .ctrl select{min-height:44px}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .btn{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      cursor:pointer;
      font-weight:600;
    }
    .btn.primary{background:var(--accent); border-color:var(--accent); color:#fff;}
    .btn.ok{background:var(--ok); border-color:var(--ok); color:#fff;}
    .btn.bad{background:var(--bad); border-color:var(--bad); color:#fff;}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .meta{margin-top:10px; color:var(--muted); font-size:12px}

    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;}
    .kpi{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background:linear-gradient(180deg,#fff, #fbfdff);
      min-height:92px;
      display:flex; flex-direction:column; justify-content:center;
    }
    .kpi .t{color:var(--muted); font-size:12px; font-weight:700}
    .kpi .v{font-size:26px; font-weight:800; margin-top:6px}
    .kpi .s{color:var(--muted); font-size:12px; margin-top:6px}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    canvas{max-width:100%}

    table{width:100%; border-collapse:collapse; font-size:13px}
    th, td{padding:10px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top}
    th{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.04em}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); color:var(--muted); background:#fff}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .titleRow{
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
      margin-bottom:8px;
    }

    @media (max-width: 980px){
      .controls{grid-template-columns: 1fr 1fr}
      .kpis{grid-template-columns: repeat(2, 1fr)}
      .grid2{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
  <header>
    <h1>Dashboard — Movimentação diária (corridas e passageiros)</h1>
    <p class="sub">Lê automaticamente o arquivo <b>dados.xlsx</b> (todas as abas) do GitHub e consolida tudo.</p>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="titleRow">
        <div class="row">
          <span class="pill">Fonte: <b id="srcName">dados.xlsx</b></span>
          <span class="pill">Abas lidas: <b id="sheetsCount">—</b></span>
          <span class="pill">Linhas: <b id="rowsCount">—</b></span>
        </div>
        <div class="row">
          <button class="btn ok" id="btnReload">Recarregar do GitHub</button>
          <button class="btn" id="btnExport">Exportar (CSV filtrado)</button>
        </div>
      </div>

      <div class="controls">
        <div class="ctrl">
          <label>Meses (pode selecionar mais de um)</label>
          <select id="monthSelect" multiple size="4"></select>
          <div class="meta">Dica: segure <b>Ctrl</b> (Windows) / <b>Cmd</b> (Mac) para selecionar mais de um.</div>
        </div>

        <div class="ctrl">
          <label>Data inicial</label>
          <input id="dateStart" type="date" />
        </div>

        <div class="ctrl">
          <label>Data final</label>
          <input id="dateEnd" type="date" />
        </div>

        <div class="ctrl">
          <label>Buscar no detalhamento</label>
          <input id="q" type="text" placeholder="ex.: janeiro, 2026-01-05, etc." />
        </div>
      </div>

      <div class="btns">
        <button class="btn primary" id="btnApply">Aplicar filtro</button>
        <button class="btn bad" id="btnReset">Resetar filtros</button>
      </div>

      <div class="meta" id="metaPeriod">—</div>
    </section>

    <section class="card">
      <div class="kpis">
        <div class="kpi"><div class="t">Corridas (total)</div><div class="v" id="k_corridas">—</div><div class="s" id="k_corridas_s">—</div></div>
        <div class="kpi"><div class="t">Finalizadas (total)</div><div class="v" id="k_finalizadas">—</div><div class="s" id="k_finalizadas_s">—</div></div>
        <div class="kpi"><div class="t">Canceladas (total)</div><div class="v" id="k_canceladas">—</div><div class="s" id="k_canceladas_s">—</div></div>
        <div class="kpi"><div class="t">Passageiros (total)</div><div class="v" id="k_passageiros">—</div><div class="s" id="k_passageiros_s">—</div></div>

        <div class="kpi"><div class="t">Vlr. Viagem (total)</div><div class="v" id="k_viagem">—</div><div class="s" id="k_viagem_s">—</div></div>
        <div class="kpi"><div class="t">Vlr. Motora (total)</div><div class="v" id="k_motora">—</div><div class="s" id="k_motora_s">—</div></div>
        <div class="kpi"><div class="t">Ticket médio (R$/corrida)</div><div class="v" id="k_ticket">—</div><div class="s" id="k_ticket_s">—</div></div>
        <div class="kpi"><div class="t">Corridas por dia (média)</div><div class="v" id="k_cpd">—</div><div class="s" id="k_cpd_s">—</div></div>
      </div>
    </section>

    <section class="grid2">
      <section class="card">
        <h3 style="margin:0 0 10px">Corridas por dia</h3>
        <canvas id="chartDays" height="140"></canvas>
      </section>

      <section class="card">
        <h3 style="margin:0 0 10px">Eficiência Operacional</h3>
        <canvas id="chartPie" height="140"></canvas>
      </section>
    </section>

    <section class="card">
      <div class="titleRow">
        <h3 style="margin:0">Detalhamento</h3>
        <span class="pill">Mostrando: <b id="shownCount">—</b></span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Planilha</th>
              <th>Data</th>
              <th>Corridas</th>
              <th>Finalizadas</th>
              <th>Canceladas</th>
              <th>Passageiros</th>
              <th>Vlr. Viagem</th>
              <th>Vlr. Motora</th>
              <th>Franquia</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
  // =============================
  // Utilitários
  // =============================
  const fmtInt = (n) => (Number.isFinite(n) ? Math.round(n).toLocaleString('pt-BR') : '—');
  const fmtMoney = (n) => (Number.isFinite(n) ? n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '—');
  const pad2 = (x) => String(x).padStart(2,'0');

  function toISODate(d){
    if(!(d instanceof Date) || isNaN(d)) return null;
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function parseExcelDate(v){
    // 1) Date já pronta
    if (v instanceof Date && !isNaN(v)) return v;

    // 2) Número serial do Excel (ex.: 45600)
    if (typeof v === 'number' && isFinite(v)) {
      // XLSX já fornece util para datas
      const dc = XLSX.SSF.parse_date_code(v);
      if (dc && dc.y && dc.m && dc.d) return new Date(dc.y, dc.m - 1, dc.d);
    }

    // 3) String: "2026-01-05" ou "2026-01-05 00:00:00" ou "05/01/2026"
    if (typeof v === 'string') {
      const s = v.trim();
      // yyyy-mm-dd...
      const m1 = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m1) return new Date(Number(m1[1]), Number(m1[2]) - 1, Number(m1[3]));
      // dd/mm/yyyy
      const m2 = s.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
      if (m2) return new Date(Number(m2[3]), Number(m2[2]) - 1, Number(m2[1]));
    }

    return null;
  }

  function toNumber(v){
    if (v === null || v === undefined) return 0;
    if (typeof v === 'number' && isFinite(v)) return v;
    if (typeof v === 'string') {
      // aceita "2.076,54" ou "2076,54" ou "2076.54"
      let s = v.trim();
      if (!s) return 0;
      // remove espaços e R$
      s = s.replace(/\s/g,'').replace(/^R\$/i,'');
      // se tem vírgula e ponto, assume pt-BR
      if (s.includes(',') && s.includes('.')) s = s.replace(/\./g,'').replace(',', '.');
      else if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
      const n = Number(s);
      return isFinite(n) ? n : 0;
    }
    return 0;
  }

  function normKey(k){
    return String(k||'').trim().toLowerCase();
  }

  // tenta achar a coluna de data por nomes comuns
  const DATE_KEYS = ['data', 'date', 'dia'];
  const CORRIDAS_KEYS = ['corridas', 'corrida', 'total corridas'];
  const FINAL_KEYS = ['finalizadas', 'finalizada', 'concluidas', 'concluídas'];
  const CANC_KEYS = ['canceladas', 'cancelada'];
  const PASS_KEYS = ['passageiros', 'passageiro'];
  const VIAGEM_KEYS = ['vlr viagem', 'valor viagem', 'viagem', 'vlr_viagem', 'vlrviagem'];
  const MOTORA_KEYS = ['vlr motora', 'valor motora', 'motora', 'vlr_motora', 'vlrmotora'];
  const FRANQ_KEYS = ['franquia', 'taxa', 'vlr franquia', 'valor franquia'];

  function findCol(cols, keys){
    const map = cols.map(c => normKey(c));
    for (const k of keys){
      const idx = map.indexOf(normKey(k));
      if (idx >= 0) return cols[idx];
    }
    // tenta "contém"
    for (let i=0;i<cols.length;i++){
      for (const k of keys){
        if (map[i].includes(normKey(k))) return cols[i];
      }
    }
    return null;
  }

  // =============================
  // Estado
  // =============================
  let allRows = [];       // todas as linhas consolidadas
  let filtered = [];      // linhas filtradas
  let chartDays = null;
  let chartPie = null;

  // =============================
  // Carregar XLSX do GitHub
  // =============================
  async function loadFromGitHub(){
    // cache-bust pra pegar sempre o mais novo
    const url = `dados.xlsx?v=${Date.now()}`;

    const resp = await fetch(url, { cache: 'no-store' });
    if (!resp.ok) throw new Error(`Não consegui baixar ${url} (HTTP ${resp.status})`);

    const buf = await resp.arrayBuffer();
    const wb = XLSX.read(buf, { type: 'array' });

    document.getElementById('sheetsCount').textContent = wb.SheetNames.length;

    const rows = [];
    for (const sheetName of wb.SheetNames){
      const ws = wb.Sheets[sheetName];
      if (!ws) continue;

     // --- encontra a linha do cabeçalho procurando "Data" (ou similar) ---
const rowsAOA = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null, raw: true });
if (!Array.isArray(rowsAOA) || rowsAOA.length === 0) continue;

// acha a linha que tem "Data" (ou "DATA", "Dia", etc.)
let headerRowIndex = -1;
for (let i = 0; i < Math.min(rowsAOA.length, 30); i++) {
  const row = rowsAOA[i] || [];
  const rowText = row.map(v => String(v ?? '').trim().toLowerCase());
  const hasDateHeader = rowText.some(t => DATE_KEYS.some(k => t === k || t.includes(k)));
  if (hasDateHeader) { headerRowIndex = i; break; }
}

// se não achou cabeçalho com Data, ignora a aba
if (headerRowIndex === -1) continue;

// monta headers normalizados
const headers = (rowsAOA[headerRowIndex] || []).map(h => String(h ?? '').trim());
const dataRows = rowsAOA.slice(headerRowIndex + 1);

// transforma em objetos {col: valor}
const json = dataRows
  .filter(r => Array.isArray(r) && r.some(v => v !== null && v !== ''))
  .map(r => {
    const obj = {};
    for (let c = 0; c < headers.length; c++) obj[headers[c]] = r[c];
    return obj;
  });

if (!json.length) continue;

// detecta colunas pelo nome
const cols = headers;
const colDate = findCol(cols, DATE_KEYS);
if (!colDate) continue;

const colCorridas = findCol(cols, CORRIDAS_KEYS);
const colFinal = findCol(cols, FINAL_KEYS);
const colCanc = findCol(cols, CANC_KEYS);
const colPass = findCol(cols, PASS_KEYS);
const colViagem = findCol(cols, VIAGEM_KEYS);
const colMotora = findCol(cols, MOTORA_KEYS);
const colFranquia = findCol(cols, FRANQ_KEYS);

      for (const r of json){
        const d = parseExcelDate(r[colDate]);
        const iso = toISODate(d);
        if (!iso) continue;

        rows.push({
          planilha: sheetName,
          data: iso,
          corridas: toNumber(colCorridas ? r[colCorridas] : 0),
          finalizadas: toNumber(colFinal ? r[colFinal] : 0),
          canceladas: toNumber(colCanc ? r[colCanc] : 0),
          passageiros: toNumber(colPass ? r[colPass] : 0),
          vlr_viagem: toNumber(colViagem ? r[colViagem] : 0),
          vlr_motora: toNumber(colMotora ? r[colMotora] : 0),
          franquia: toNumber(colFranquia ? r[colFranquia] : 0),
        });
      }
    }

    if (rows.length === 0){
      throw new Error('Não consegui identificar linhas com datas no XLSX. Verifique se as abas têm uma coluna "Data" (ou similar) e cabeçalho na linha 1.');
    }

    // ordena por data
    rows.sort((a,b) => a.data.localeCompare(b.data));

    allRows = rows;
    document.getElementById('rowsCount').textContent = rows.length;

    // prepara filtros padrão
    setupFilters();
    applyFilters();
  }

  function setupFilters(){
    // meses disponíveis (YYYY-MM)
    const months = Array.from(new Set(allRows.map(r => r.data.slice(0,7))));
    const sel = document.getElementById('monthSelect');
    sel.innerHTML = '';
    for (const m of months){
      const opt = document.createElement('option');
      const [y,mm] = m.split('-');
      const monthName = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'][Number(mm)-1];
      opt.value = m;
      opt.textContent = `${monthName} de ${y}`;
      sel.appendChild(opt);
    }

    // datas mín/máx
    const minD = allRows[0]?.data || '';
    const maxD = allRows[allRows.length-1]?.data || '';
    document.getElementById('dateStart').value = minD;
    document.getElementById('dateEnd').value = maxD;

    // por padrão seleciona o último mês
    if (months.length){
      const last = months[months.length-1];
      for (const opt of sel.options){
        opt.selected = (opt.value === last);
      }
    }
  }

  function getSelectedMonths(){
    const sel = document.getElementById('monthSelect');
    return Array.from(sel.selectedOptions).map(o => o.value);
  }

  function applyFilters(){
    const start = document.getElementById('dateStart').value;
    const end = document.getElementById('dateEnd').value;
    const q = (document.getElementById('q').value || '').trim().toLowerCase();
    const months = getSelectedMonths();

    filtered = allRows.filter(r => {
      const okDate = (!start || r.data >= start) && (!end || r.data <= end);
      const okMonth = months.length ? months.includes(r.data.slice(0,7)) : true;
      const okQ = q ? (
        r.planilha.toLowerCase().includes(q) ||
        r.data.includes(q)
      ) : true;
      return okDate && okMonth && okQ;
    });

    renderMeta();
    renderKPIs();
    renderCharts();
    renderTable();
  }

  function resetFilters(){
    const minD = allRows[0]?.data || '';
    const maxD = allRows[allRows.length-1]?.data || '';
    document.getElementById('dateStart').value = minD;
    document.getElementById('dateEnd').value = maxD;
    document.getElementById('q').value = '';

    // seleciona último mês
    const months = Array.from(new Set(allRows.map(r => r.data.slice(0,7))));
    const last = months[months.length-1];
    const sel = document.getElementById('monthSelect');
    for (const opt of sel.options){
      opt.selected = (opt.value === last);
    }

    applyFilters();
  }

  function renderMeta(){
    const start = document.getElementById('dateStart').value;
    const end = document.getElementById('dateEnd').value;
    const months = getSelectedMonths();
    document.getElementById('metaPeriod').textContent =
      `Período: ${start || '—'} até ${end || '—'} • Meses: ${months.length ? months.join(', ') : 'todos'} • Linhas filtradas: ${filtered.length}`;
  }

  function sum(key){
    return filtered.reduce((acc,r) => acc + (Number(r[key])||0), 0);
  }

  function renderKPIs(){
    const corridas = sum('corridas');
    const finalizadas = sum('finalizadas');
    const canceladas = sum('canceladas');
    const passageiros = sum('passageiros');
    const vlr_viagem = sum('vlr_viagem');
    const vlr_motora = sum('vlr_motora');
    const franquia = sum('franquia');

    const taxaFinal = (corridas>0) ? (finalizadas/corridas) : 0;
    const taxaCanc = (corridas>0) ? (canceladas/corridas) : 0;
    const ticket = (finalizadas>0) ? (vlr_viagem/finalizadas) : 0;

    // dias únicos com dados
    const dias = new Set(filtered.map(r => r.data)).size || 0;
    const cpd = (dias>0) ? (finalizadas/dias) : 0;

    document.getElementById('k_corridas').textContent = fmtInt(corridas);
    document.getElementById('k_finalizadas').textContent = fmtInt(finalizadas);
    document.getElementById('k_canceladas').textContent = fmtInt(canceladas);
    document.getElementById('k_passageiros').textContent = fmtInt(passageiros);

    document.getElementById('k_viagem').textContent = fmtMoney(vlr_viagem);
    document.getElementById('k_motora').textContent = fmtMoney(vlr_motora);
    document.getElementById('k_ticket').textContent = fmtMoney(ticket);
    document.getElementById('k_cpd').textContent = Number.isFinite(cpd) ? cpd.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) : '—';

    document.getElementById('k_corridas_s').textContent = `Franquia (total): ${fmtMoney(franquia)}`;
    document.getElementById('k_finalizadas_s').textContent = `Taxa de finalização: ${(taxaFinal*100).toLocaleString('pt-BR',{maximumFractionDigits:2})}%`;
    document.getElementById('k_canceladas_s').textContent = `Taxa de cancelamento: ${(taxaCanc*100).toLocaleString('pt-BR',{maximumFractionDigits:2})}%`;
    document.getElementById('k_passageiros_s').textContent = `Total geral (somado): ${fmtInt(passageiros)}`;
    document.getElementById('k_viagem_s').textContent = `Base: soma do período`;
    document.getElementById('k_motora_s').textContent = `Base: soma do período`;
    document.getElementById('k_ticket_s').textContent = `Base: Vlr. Viagem / Finalizadas`;
    document.getElementById('k_cpd_s').textContent = `Finalizadas (${fmtInt(finalizadas)}) ÷ ${fmtInt(dias)} dia(s) com dados`;
  }

  function renderCharts(){
    // agrega por dia
    const byDay = new Map();
    for (const r of filtered){
      const d = r.data;
      const cur = byDay.get(d) || {corridas:0, finalizadas:0, canceladas:0};
      cur.corridas += Number(r.corridas)||0;
      cur.finalizadas += Number(r.finalizadas)||0;
      cur.canceladas += Number(r.canceladas)||0;
      byDay.set(d, cur);
    }
    const labels = Array.from(byDay.keys()).sort();
    const corridas = labels.map(d => byDay.get(d).corridas);
    const finalizadas = labels.map(d => byDay.get(d).finalizadas);
    const canceladas = labels.map(d => byDay.get(d).canceladas);

    // chartDays
    const ctx1 = document.getElementById('chartDays');
    if (chartDays) chartDays.destroy();
    chartDays = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Corridas', data: corridas },
          { label: 'Finalizadas', data: finalizadas },
          { label: 'Canceladas', data: canceladas },
        ]
      },
      options: {
        responsive:true,
        plugins:{ legend:{ position:'top' } },
        scales:{
          x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:10 } },
          y:{ beginAtZero:true }
        }
      }
    });

    // pie
    const ctx2 = document.getElementById('chartPie');
    if (chartPie) chartPie.destroy();
    const totalFinal = sum('finalizadas');
    const totalCanc = sum('canceladas');

    chartPie = new Chart(ctx2, {
      type:'doughnut',
      data:{
        labels:['Finalizadas','Canceladas'],
        datasets:[{ data:[totalFinal, totalCanc] }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{ position:'top' } }
      }
    });
  }

  function renderTable(){
    const tb = document.getElementById('tbody');
    tb.innerHTML = '';
    document.getElementById('shownCount').textContent = fmtInt(filtered.length);

    // mostra no máximo 500 linhas pra não travar
    const MAX = 500;
    const slice = filtered.slice(0, MAX);

    for (const r of slice){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHTML(r.planilha)}</td>
        <td>${escapeHTML(r.data)}</td>
        <td>${fmtInt(r.corridas)}</td>
        <td>${fmtInt(r.finalizadas)}</td>
        <td>${fmtInt(r.canceladas)}</td>
        <td>${fmtInt(r.passageiros)}</td>
        <td>${fmtMoney(r.vlr_viagem)}</td>
        <td>${fmtMoney(r.vlr_motora)}</td>
        <td>${fmtMoney(r.franquia)}</td>
      `;
      tb.appendChild(tr);
    }

    if (filtered.length > MAX){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="9" style="color:#64748b">Mostrando apenas as primeiras ${MAX} linhas (para desempenho). Ajuste os filtros para ver menos linhas.</td>`;
      tb.appendChild(tr);
    }
  }

  function escapeHTML(s){
    return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function exportFilteredCSV(){
    const header = ['Planilha','Data','Corridas','Finalizadas','Canceladas','Passageiros','Vlr_Viagem','Vlr_Motora','Franquia'];
    const lines = [header.join(';')];

    for (const r of filtered){
      lines.push([
        r.planilha,
        r.data,
        (Number(r.corridas)||0),
        (Number(r.finalizadas)||0),
        (Number(r.canceladas)||0),
        (Number(r.passageiros)||0),
        (Number(r.vlr_viagem)||0).toFixed(2).replace('.',','),
        (Number(r.vlr_motora)||0).toFixed(2).replace('.',','),
        (Number(r.franquia)||0).toFixed(2).replace('.',',')
      ].join(';'));
    }

    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `dashboard_export_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // =============================
  // Eventos
  // =============================
  document.getElementById('btnReload').addEventListener('click', async () => {
    try{
      document.getElementById('btnReload').disabled = true;
      await loadFromGitHub();
      alert('Recarregado com sucesso do dados.xlsx ✅');
    }catch(e){
      console.error(e);
      alert(e.message || 'Falha ao carregar dados.xlsx');
    }finally{
      document.getElementById('btnReload').disabled = false;
    }
  });

  document.getElementById('btnApply').addEventListener('click', applyFilters);
  document.getElementById('btnReset').addEventListener('click', resetFilters);
  document.getElementById('btnExport').addEventListener('click', exportFilteredCSV);

  // aplica ao mudar filtros
  document.getElementById('monthSelect').addEventListener('change', applyFilters);
  document.getElementById('dateStart').addEventListener('change', applyFilters);
  document.getElementById('dateEnd').addEventListener('change', applyFilters);
  document.getElementById('q').addEventListener('input', () => {
    // debounce simples
    clearTimeout(window.__qT);
    window.__qT = setTimeout(applyFilters, 180);
  });

  // =============================
  // Inicialização
  // =============================
  (async function init(){
    try{
      await loadFromGitHub();
    }catch(e){
      console.error(e);
      alert(e.message || 'Falha ao abrir dados.xlsx');
    }
  })();
</script>
</body>
</html>
