<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard — Movimentação diária (corridas e passageiros)</title>

  <!-- Bibliotecas -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#e2e8f0;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --radius:18px;
      --pad:18px;
      --gap:14px;
      --accent:#2563eb;
      --ok:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(900px 500px at 10% 10%, rgba(37,99,235,.08), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(22,163,74,.08), transparent 55%),
                  linear-gradient(180deg, var(--bg), #ffffff);
      color:var(--text);
      line-height:1.35;
    }
    header{
      max-width:1200px;
      margin:0 auto;
      padding:26px 18px 6px;
    }
    h1{margin:0 0 8px; font-size:26px;}
    .sub{margin:0; color:var(--muted); font-size:14px;}
    .wrap{max-width:1200px; margin:0 auto; padding:14px 18px 30px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .leftControls{display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;}
    .ctrl{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:220px;
    }
    label{font-size:13px; color:var(--muted)}
    input[type="date"], input[type="file"], select{
      height:38px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:6px 10px;
      font-size:14px;
      background:#fff;
    }
    select[multiple]{height:auto; min-height:120px; padding:10px;}
    .btns{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
    button{
      border:0;
      border-radius:999px;
      padding:10px 14px;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
      box-shadow:0 6px 18px rgba(15,23,42,.08);
      background:#fff;
      border:1px solid var(--border);
    }
    button.primary{background:var(--accent); color:#fff; border-color:transparent;}
    button.danger{background:var(--bad); color:#fff; border-color:transparent;}
    .hint{font-size:12px; color:var(--muted); margin-top:6px;}
    .statusLine{margin-top:10px; color:var(--muted); font-size:12px;}
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:14px;
      margin-top:14px;
    }
    @media(max-width:1000px){ .grid{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media(max-width:560px){ .grid{grid-template-columns: 1fr;} .ctrl{min-width:100%;} }
    .kpi{
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      background: linear-gradient(180deg, #ffffff, #fbfdff);
      position:relative;
      overflow:hidden;
    }
    .kpi::after{
      content:"";
      position:absolute;
      right:-40px; top:-40px;
      width:140px; height:140px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(37,99,235,.15), transparent 70%);
      filter: blur(0px);
    }
    .kpi h3{margin:0; font-size:13px; color:var(--muted); font-weight:700;}
    .kpi .v{margin-top:6px; font-size:26px; font-weight:800;}
    .kpi .s{margin-top:6px; font-size:12px; color:var(--muted);}
    .kpi.b{border-left:6px solid var(--accent)}
    .kpi.g{border-left:6px solid var(--ok)}
    .kpi.r{border-left:6px solid var(--bad)}
    .kpi.y{border-left:6px solid var(--warn)}

    .sectionTitle{
      margin-top:18px;
      margin-bottom:10px;
      font-size:16px;
      font-weight:800;
    }
    .charts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:10px;
    }
    @media(max-width:900px){ .charts{grid-template-columns:1fr;} }
    canvas{width:100%; height:320px;}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid var(--border);
      padding:10px 8px;
      text-align:left;
      white-space:nowrap;
    }
    th{color:var(--muted); font-weight:800; font-size:12px;}
    .tableWrap{overflow:auto; border:1px solid var(--border); border-radius:16px;}
  </style>
</head>

<body>
  <header>
    <h1>Dashboard — Movimentação diária (corridas e passageiros)</h1>
    <p class="sub">Agora o site tenta carregar automaticamente <b>dados.csv</b> do GitHub. Se quiser, você ainda pode importar manualmente.</p>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="controls">
        <div class="leftControls">
          <div class="ctrl" style="min-width: 320px;">
            <label>Importar CSV (separador ;)</label>
            <input id="fileInput" type="file" accept=".csv,text/csv" />
            <div class="hint">Dica: mantenha o arquivo no repositório como <b>dados.csv</b>.</div>
          </div>

          <div class="ctrl">
            <label>Data inicial</label>
            <input id="dateStart" type="date" />
          </div>

          <div class="ctrl">
            <label>Data final</label>
            <input id="dateEnd" type="date" />
          </div>

          <div class="ctrl">
            <label>Meses</label>
            <select id="monthSelect" multiple size="5"></select>
            <div class="hint">Ctrl (Windows) para selecionar mais de 1 mês.</div>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnReplace">Carregar e substituir dados</button>
          <button id="btnMerge">Adicionar atualização (mesclar)</button>
          <button class="danger" id="btnReset">Resetar para dados do arquivo enviado</button>
          <button id="btnClearMonths">Limpar meses</button>
          <button id="btnExport">Exportar (CSV filtrado)</button>
        </div>
      </div>

      <div class="statusLine" id="statusLine">Aguardando dados…</div>
    </section>

    <div class="sectionTitle" id="titlePeriod">—</div>

    <section class="card">
      <div class="grid">
        <div class="kpi b">
          <h3>Corridas (total)</h3>
          <div class="v" id="kpiCorridas">—</div>
          <div class="s" id="kpiCorridasSub">—</div>
        </div>

        <div class="kpi g">
          <h3>Finalizadas (total)</h3>
          <div class="v" id="kpiFinalizadas">—</div>
          <div class="s" id="kpiFinalizadasSub">—</div>
        </div>

        <div class="kpi r">
          <h3>Canceladas (total)</h3>
          <div class="v" id="kpiCanceladas">—</div>
          <div class="s" id="kpiCanceladasSub">—</div>
        </div>

        <div class="kpi">
          <h3>Passageiros (total do período)</h3>
          <div class="v" id="kpiPassageiros">—</div>
          <div class="s" id="kpiPassageirosSub">—</div>
        </div>

        <div class="kpi y">
          <h3>Vlr. Viagem (total)</h3>
          <div class="v" id="kpiVlrViagem">—</div>
          <div class="s" id="kpiVlrViagemSub">—</div>
        </div>

        <div class="kpi">
          <h3>Vlr. Motora (total)</h3>
          <div class="v" id="kpiVlrMotora">—</div>
          <div class="s" id="kpiVlrMotoraSub">—</div>
        </div>

        <div class="kpi">
          <h3>Ticket médio (R$/corrida)</h3>
          <div class="v" id="kpiTicket">—</div>
          <div class="s" id="kpiTicketSub">—</div>
        </div>

        <div class="kpi">
          <h3>Corridas por dia (média)</h3>
          <div class="v" id="kpiCorridasDia">—</div>
          <div class="s" id="kpiCorridasDiaSub">—</div>
        </div>
      </div>

      <div class="charts">
        <div class="card" style="box-shadow:none;">
          <div class="sectionTitle" style="margin-top:0;">Corridas por dia</div>
          <canvas id="chartDaily"></canvas>
        </div>
        <div class="card" style="box-shadow:none;">
          <div class="sectionTitle" style="margin-top:0;">Eficiência Operacional</div>
          <canvas id="chartPie"></canvas>
        </div>
      </div>
    </section>

    <div class="sectionTitle">Tabela detalhada</div>
    <section class="card">
      <div class="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Mês(aba)</th>
              <th>Data</th>
              <th>Corridas</th>
              <th>Finalizadas</th>
              <th>Canceladas</th>
              <th>Passageiros</th>
              <th>Vlr Viagem</th>
              <th>Franquia</th>
              <th>Vlr Motora</th>
              <th>Mot. a receber</th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
/**
 * FORMATO ESPERADO (SEPARADOR ;)
 * Exemplo de linha:
 * janeiro26;2026-01-05;46;31;15;19;2963;2026-01-05 00:00:00;31;653.81;65.38;588.43;93.09;0.1582
 *
 * Vamos usar:
 * 0 Planilha/aba
 * 1 Data (YYYY-MM-DD)  <-- ESSA É A DATA PRINCIPAL
 * 2 Corridas
 * 3 Finalizadas
 * 4 Canceladas
 * 6 Passageiros
 * 9 Vlr Viagem
 * 10 Franquia
 * 11 Vlr Motora
 * 12 Mot a receber
 */

const DATA_URL = 'dados.csv';

let rawData = [];         // dados normalizados
let sourceFileData = [];  // último arquivo carregado manualmente
let chartDaily = null;
let chartPie = null;

const el = (id) => document.getElementById(id);

function toISODate(s){
  // aceita "2026-01-05" ou "2026-01-05 00:00:00"
  if(!s) return null;
  const t = String(s).trim();
  const m = t.match(/^(\d{4}-\d{2}-\d{2})/);
  return m ? m[1] : null;
}

function monthKey(iso){ // "2026-01-05" -> "2026-01"
  return iso ? iso.slice(0,7) : null;
}

function monthLabel(key){ // "2026-01" -> "jan de 2026"
  const [y,m] = key.split('-').map(x=>parseInt(x,10));
  const nomes = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
  return `${nomes[m-1]} de ${y}`;
}

function n(v){
  const x = Number(String(v ?? '').replace(',', '.'));
  return Number.isFinite(x) ? x : 0;
}

function brMoney(v){
  return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
}
function brInt(v){
  return v.toLocaleString('pt-BR');
}
function brPct(v){
  return (v*100).toFixed(2).replace('.',',') + '%';
}

function normalizeRows(rows){
  // rows pode vir de Papa com header false (array) ou header true (obj)
  const out = [];
  for(const r of rows){
    const arr = Array.isArray(r) ? r : Object.values(r);
    const planilha = (arr[0] ?? '').toString().trim();
    const dataISO = toISODate(arr[1]);
    if(!dataISO) continue;

    out.push({
      planilha,
      dataISO,
      corridas: n(arr[2]),
      finalizadas: n(arr[3]),
      canceladas: n(arr[4]),
      passageiros: n(arr[6]),
      vlr_viagem: n(arr[9]),
      franquia: n(arr[10]),
      vlr_motora: n(arr[11]),
      mot_a_receber: n(arr[12]),
      _raw: arr
    });
  }
  // ordena por data
  out.sort((a,b)=>a.dataISO.localeCompare(b.dataISO));
  return out;
}

function parseCSVText(csvText){
  const parsed = Papa.parse(csvText, {
    delimiter: ';',
    skipEmptyLines: true
  });

  if(parsed.errors && parsed.errors.length){
    console.warn(parsed.errors);
  }
  // remove header se parecer header (contém "Data" na coluna 2)
  const data = parsed.data || [];
  let rows = data;
  if(rows.length && String(rows[0][1] ?? '').toLowerCase().includes('data')){
    rows = rows.slice(1);
  }
  const norm = normalizeRows(rows);

  if(!norm.length){
    throw new Error('Não consegui identificar linhas com datas no CSV. Verifique o formato (Planilha;Data;Corridas;...).');
  }
  return norm;
}

function setStatus(msg){
  el('statusLine').textContent = msg;
}

function setDateInputsFromData(data){
  if(!data.length) return;
  el('dateStart').value = data[0].dataISO;
  el('dateEnd').value = data[data.length-1].dataISO;
}

function buildMonthSelect(data){
  const sel = el('monthSelect');
  const months = [...new Set(data.map(r => monthKey(r.dataISO)).filter(Boolean))];
  sel.innerHTML = '';
  for(const m of months){
    const opt = document.createElement('option');
    opt.value = m;
    opt.textContent = monthLabel(m);
    sel.appendChild(opt);
  }
}

function getSelectedMonths(){
  const sel = el('monthSelect');
  return [...sel.selectedOptions].map(o=>o.value);
}

function filterData(){
  const ds = el('dateStart').value;
  const de = el('dateEnd').value;
  const months = getSelectedMonths();

  return rawData.filter(r=>{
    if(ds && r.dataISO < ds) return false;
    if(de && r.dataISO > de) return false;
    if(months.length && !months.includes(monthKey(r.dataISO))) return false;
    return true;
  });
}

function refreshTitle(filtered){
  if(!filtered.length){
    el('titlePeriod').textContent = 'Sem dados no filtro';
    return;
  }
  const ds = filtered[0].dataISO;
  const de = filtered[filtered.length-1].dataISO;

  const months = [...new Set(filtered.map(r=>monthKey(r.dataISO)))];
  const monthsLabel = months.length ? months.map(monthLabel).join(' • ') : '—';
  el('titlePeriod').textContent = monthsLabel;
  setStatus(`Período: ${ds} até ${de} • Meses: ${months.join(', ')} • Linhas: ${filtered.length}`);
}

function sum(filtered){
  const total = {
    corridas:0, finalizadas:0, canceladas:0, passageiros:0,
    vlr_viagem:0, franquia:0, vlr_motora:0, mot_a_receber:0
  };
  for(const r of filtered){
    total.corridas += r.corridas;
    total.finalizadas += r.finalizadas;
    total.canceladas += r.canceladas;
    total.passageiros += r.passageiros;
    total.vlr_viagem += r.vlr_viagem;
    total.franquia += r.franquia;
    total.vlr_motora += r.vlr_motora;
    total.mot_a_receber += r.mot_a_receber;
  }
  return total;
}

function refreshKPIs(filtered){
  if(!filtered.length){
    ['kpiCorridas','kpiFinalizadas','kpiCanceladas','kpiPassageiros','kpiVlrViagem','kpiVlrMotora','kpiTicket','kpiCorridasDia']
      .forEach(id=>el(id).textContent='—');
    return;
  }

  const t = sum(filtered);
  const taxaFin = t.corridas > 0 ? (t.finalizadas / t.corridas) : 0;
  const taxaCanc = t.corridas > 0 ? (t.canceladas / t.corridas) : 0;
  const ticket = t.finalizadas > 0 ? (t.vlr_viagem / t.finalizadas) : 0;

  const diasComDados = new Set(filtered.map(r=>r.dataISO)).size;
  const corridasDia = diasComDados > 0 ? (t.finalizadas / diasComDados) : 0;

  el('kpiCorridas').textContent = brInt(t.corridas);
  el('kpiCorridasSub').textContent = `Dias com dados: ${diasComDados}`;

  el('kpiFinalizadas').textContent = brInt(t.finalizadas);
  el('kpiFinalizadasSub').textContent = `Taxa de finalização: ${brPct(taxaFin)}`;

  el('kpiCanceladas').textContent = brInt(t.canceladas);
  el('kpiCanceladasSub').textContent = `Taxa de cancelamento: ${brPct(taxaCanc)}`;

  el('kpiPassageiros').textContent = brInt(t.passageiros);
  el('kpiPassageirosSub').textContent = `Total geral: ${brInt(t.passageiros)}`;

  el('kpiVlrViagem').textContent = brMoney(t.vlr_viagem);
  el('kpiVlrViagemSub').textContent = `Franquia (total): ${brMoney(t.franquia)}`;

  el('kpiVlrMotora').textContent = brMoney(t.vlr_motora);
  el('kpiVlrMotoraSub').textContent = `Mot. a receber (total): ${brMoney(t.mot_a_receber)}`;

  el('kpiTicket').textContent = brMoney(ticket);
  el('kpiTicketSub').textContent = 'Base: Vlr. Viagem / Finalizadas';

  el('kpiCorridasDia').textContent = corridasDia.toFixed(2).replace('.',',');
  el('kpiCorridasDiaSub').textContent = `Corridas finalizadas (${brInt(t.finalizadas)}) ÷ ${diasComDados} dia(s)`;
}

function refreshTable(filtered){
  const tb = el('tblBody');
  tb.innerHTML = '';
  for(const r of filtered){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.planilha || '-'}</td>
      <td>${r.dataISO}</td>
      <td>${brInt(r.corridas)}</td>
      <td>${brInt(r.finalizadas)}</td>
      <td>${brInt(r.canceladas)}</td>
      <td>${brInt(r.passageiros)}</td>
      <td>${brMoney(r.vlr_viagem)}</td>
      <td>${brMoney(r.franquia)}</td>
      <td>${brMoney(r.vlr_motora)}</td>
      <td>${brMoney(r.mot_a_receber)}</td>
    `;
    tb.appendChild(tr);
  }
}

function refreshCharts(filtered){
  // Agrupa por dia
  const byDay = new Map();
  for(const r of filtered){
    if(!byDay.has(r.dataISO)){
      byDay.set(r.dataISO, {corridas:0, finalizadas:0, canceladas:0});
    }
    const o = byDay.get(r.dataISO);
    o.corridas += r.corridas;
    o.finalizadas += r.finalizadas;
    o.canceladas += r.canceladas;
  }
  const labels = [...byDay.keys()].sort();
  const corridas = labels.map(d=>byDay.get(d).corridas);
  const finalizadas = labels.map(d=>byDay.get(d).finalizadas);
  const canceladas = labels.map(d=>byDay.get(d).canceladas);

  // Chart diário
  if(chartDaily) chartDaily.destroy();
  chartDaily = new Chart(document.getElementById('chartDaily'), {
    type:'line',
    data:{
      labels,
      datasets:[
        {label:'Corridas', data:corridas},
        {label:'Finalizadas', data:finalizadas},
        {label:'Canceladas', data:canceladas},
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{position:'top'}},
      scales:{x:{ticks:{maxRotation:0, autoSkip:true}}}
    }
  });

  // Pie eficiência
  const t = sum(filtered);
  if(chartPie) chartPie.destroy();
  chartPie = new Chart(document.getElementById('chartPie'), {
    type:'doughnut',
    data:{
      labels:['Finalizadas','Canceladas'],
      datasets:[{data:[t.finalizadas, t.canceladas]}]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{position:'top'}}
    }
  });
}

function refreshAll(){
  const filtered = filterData();
  refreshTitle(filtered);
  refreshKPIs(filtered);
  refreshCharts(filtered);
  refreshTable(filtered);
}

function mergeData(base, incoming){
  // Mescla por dataISO (se repetir, soma)
  const map = new Map();
  for(const r of base){
    map.set(r.dataISO, {...r});
  }
  for(const r of incoming){
    if(map.has(r.dataISO)){
      const o = map.get(r.dataISO);
      // soma campos principais
      o.corridas += r.corridas;
      o.finalizadas += r.finalizadas;
      o.canceladas += r.canceladas;
      o.passageiros += r.passageiros;
      o.vlr_viagem += r.vlr_viagem;
      o.franquia += r.franquia;
      o.vlr_motora += r.vlr_motora;
      o.mot_a_receber += r.mot_a_receber;
      // mantém planilha mais recente se vier
      if(r.planilha) o.planilha = r.planilha;
      map.set(r.dataISO, o);
    } else {
      map.set(r.dataISO, {...r});
    }
  }
  const out = [...map.values()];
  out.sort((a,b)=>a.dataISO.localeCompare(b.dataISO));
  return out;
}

async function readFileAsText(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(fr.result);
    fr.onerror = ()=>reject(fr.error);
    fr.readAsText(file, 'utf-8');
  });
}

async function loadFromFile(mode){ // 'replace' | 'merge'
  const input = el('fileInput');
  if(!input.files || !input.files[0]){
    alert('Escolha um arquivo CSV primeiro (botão Procurar).');
    return;
  }
  try{
    const txt = await readFileAsText(input.files[0]);
    const incoming = parseCSVText(txt);

    sourceFileData = incoming;

    if(mode === 'replace'){
      rawData = incoming;
    } else {
      rawData = mergeData(rawData, incoming);
    }

    setDateInputsFromData(rawData);
    buildMonthSelect(rawData);
    refreshAll();
  }catch(e){
    alert(e.message || String(e));
  }
}

function exportFilteredCSV(){
  const filtered = filterData();
  if(!filtered.length){
    alert('Nada para exportar no filtro atual.');
    return;
  }

  // reconstrói CSV no mesmo padrão (Planilha;Data;Corridas;Finalizadas;Canceladas;...etc)
  const header = ['Planilha','Data','Corridas','Finalizadas','Canceladas','(col5)','Passageiros','(col7)','(col8)','VlrViagem','Franquia','VlrMotora','MotAReceber'];
  const lines = [header.join(';')];

  for(const r of filtered){
    const line = [
      r.planilha ?? '',
      r.dataISO ?? '',
      r.corridas ?? 0,
      r.finalizadas ?? 0,
      r.canceladas ?? 0,
      '', // col5 desconhecida
      r.passageiros ?? 0,
      '', '', // col7 col8 desconhecidas
      (r.vlr_viagem ?? 0).toFixed(2),
      (r.franquia ?? 0).toFixed(2),
      (r.vlr_motora ?? 0).toFixed(2),
      (r.mot_a_receber ?? 0).toFixed(2),
    ].join(';');
    lines.push(line);
  }

  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'dashboard_export_filtrado.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
}

async function autoLoadDadosCSV(){
  // tenta buscar dados.csv do próprio GitHub Pages (sem cache)
  try{
    const url = DATA_URL + '?v=' + Date.now();
    const resp = await fetch(url, {cache:'no-store'});
    if(!resp.ok) throw new Error('Falha ao baixar ' + DATA_URL);
    const txt = await resp.text();
    const incoming = parseCSVText(txt);

    rawData = incoming;

    setDateInputsFromData(rawData);
    buildMonthSelect(rawData);

    // Seleciona automaticamente o último mês
    const months = [...new Set(rawData.map(r=>monthKey(r.dataISO)).filter(Boolean))];
    const last = months[months.length-1];
    if(last){
      const sel = el('monthSelect');
      [...sel.options].forEach(o=>o.selected = (o.value === last));
    }

    refreshAll();
  }catch(e){
    // Não trava o site. Só avisa.
    console.warn(e);
    alert('Não consegui identificar linhas com datas no CSV. Verifique se ele está no formato (Planilha;Data;Corridas;...).');
  }
}

/* Eventos */
el('monthSelect').addEventListener('change', refreshAll);
el('dateStart').addEventListener('change', refreshAll);
el('dateEnd').addEventListener('change', refreshAll);

el('btnReplace').addEventListener('click', ()=>loadFromFile('replace'));
el('btnMerge').addEventListener('click', ()=>loadFromFile('merge'));
el('btnClearMonths').addEventListener('click', ()=>{
  const sel = el('monthSelect');
  [...sel.options].forEach(o=>o.selected=false);
  refreshAll();
});
el('btnReset').addEventListener('click', ()=>{
  // volta para o último arquivo manual enviado (se existir), senão mantém o atual
  if(sourceFileData && sourceFileData.length){
    rawData = sourceFileData.slice();
    setDateInputsFromData(rawData);
    buildMonthSelect(rawData);
    refreshAll();
  }else{
    // se não tiver arquivo manual, tenta recarregar do dados.csv
    autoLoadDadosCSV();
  }
});
el('btnExport').addEventListener('click', exportFilteredCSV);

/* Inicializa */
setStatus('Carregando dados.csv do GitHub…');
autoLoadDadosCSV();
</script>
</body>
</html>
